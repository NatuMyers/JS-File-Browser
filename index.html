<!DOCTYPE html>
<html>

	<head>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

		<!-- this is how we connecting to the api's "files" -->
		<script src="http://storage.googleapis.com/el-static/test/filedata.js"></script>
		<script src="static/js/fbrowse.js"></script>

		<meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />

    <title>File Viewer</title>

    <link rel="shortcut icon" href="/static/img/favicon.ico"></link>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <link rel="stylesheet" href="/static/css/materialize.min.css" media="screen" title="no title">
		<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Julius+Sans+One">

    <!-- load order is extremely important -->
    <!-- jquery THEN materialize THEN custom -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="/static/js/materialize.min.js"></script>
    <script src="/static/js/custom.js"></script>
	</head>

	<body class="grey lighten-4">
		<div class="container">
			<span id="target"></span>
			<pre></pre>

			<div class="row">

			<script type="text/javascript">
				// add the function to th window object because the scope is wayy to small http://stackoverflow.com/questions/2223305/how-can-i-make-a-function-defined-in-jquery-ready-available-globally
				window.parse = function myself(payload="#/".replace('#','')) {
					filedata.getFilesForPath( (payload) , function(err, files){
					console.log("Current Payload: " + payload); // for debug

					// loop through all the files in the directory
					var markup = ""; // to be rendered
					var numberOfFiles = files.length;

					// we call render view like this on IF we're on the root page
					if ( (("window.location.href".match(/#/g) || []).length) < 1 ) {
						renderView() // call it (at root)
					}

					// the idea is to keep calling renderView by appending stuff to payload when we get deeper

					// RENDER VIEW
					function renderView(payload="#/", markup = "", numberOfFiles = files.length, will_update = false) {
						for (var i = 0; i < numberOfFiles; i++) {

							// This uses escape quotes: http://stackoverflow.com/questions/2004168/escape-quotes-in-javascript
							// and a multiline strings: http://stackoverflow.com/questions/805107/creating-multiline-strings-in-javascript
							// to build something like this: http://jsfiddle.net/wmkNe/1/

							if (files[i].isFolder) {
									markup = markup + " \
									 <div class=\"col s12 m64 l4\"> \
											<div class=\"card shake hoverable light-blue darken-4 \"> \
												<div class=\"card-image\"> \
													<img  src=\"/static/images/folder.png\" width= \"30px\"  draggable=\"false\"> \
												</div> \
												<div class=\"card-content center truncate\"> \
												\
												\<!-- we pass the file in as a string, not a var. http://stackoverflow.com/questions/5504515/javascript-variable-is-not-defined  \
												 and do a nested function call to render with a new payload. -->\
												 \
													<a onclick=\"window.parse(goDeeper("+ "'" + files[i].name+ "'" + ")) \" class=\"card-title hoverable btn center yellow darken-2 waves-effect waves-light\" style=\"font-family:  'Julius Sans One', regular; font-size:160%;\">"  + files[i].name +  "</a> \
												</div> \
											</div> \
										</div>"
									} else {
										markup = markup + " \
										 <div class=\"col s12 m64 l4\"> \
												<div class=\"card shake hoverable light-green darken-3 \"> \
													<div class=\"card-image\"> \
														<img  src=\"/static/images/file.png\" width= \"30px\"> \
													</div> \
													<div class=\"card-content center\"> \
														<a class=\"card-title hoverable btn center  teal darken-2  waves-effect waves-light\" style=\"font-family:  'Julius Sans One', regular; font-size:160%;\">"  + files[i].name +  "</a> \
													</div> \
												</div> \
											</div>"
									}
							}

							// to go up a level
							if (payload.length > 3) { // appears when not in root.  "/" and "" are non-root payloads
							markup = markup + " \
							 <div class=\"col s12 m64 l4\"> \
									<div class=\"card shake hoverable white \"> \
										<div class=\"card-image\"> \
										</div> \
										<div class=\"card-content center truncate\"> \
											<a onclick=\"goUp()\" class=\"card-title hoverable btn center yellow darken-2 waves-effect waves-light\" style=\"font-family:  'Julius Sans One', regular; font-size:160%;\"> Up A Level</a> \
										</div> \
									</div> \
								</div>"
							}

							// to partition it
							if (i/3 == 0) {
								var markup = markup + "<br>"
							}

							document.write(markup); // write the js-rendered html

							// for debug purposes
							console.log("Error: ", err);
							console.log("Files: ", files); // files is an array of our...FILES! (like typing ls)
					}
				});
			}

				window.parse()
			// go up a directory
			function goUp() {
				var directory = current_payload.split('/'); // http://stackoverflow.com/questions/5269856/how-to-split-comma-separated-string-using-javascript
				// Basically cut off the last part of the array to go up a directory.
				if (directory.length >= 1) { // else, it's the root directory anyway.
					var new_payload = current_payload.replace(directory[directory.length - 1], ''); // remove the last filename
				}
					// now GO.
					window.location.href = new_payload; // http://stackoverflow.com/questions/1226714/how-to-get-browser-to-navigate-to-url-in-javascript
			}

			// go in a directory
			function goDeeper(foldername) { // ex: Documents. just the directory or foldername

				var target = "/" + (window.location.hash + foldername).replace('#','')
				console.log(target)
				return target

				// window.location.href = "#" + new_payload;
			}

			function thisisme(target){
				filedata.getFilesForPath( (payload="target".replace('#','')), thisisme(8) )

			}

			// go in a directory
			function goView(filename) {
				// Append to the end of the current payload
				var new_payload = ""
				 new_payload = current_payload.concat("/"+foldername);
				// now GO.
				window.location.href = window.location.hostname + new_payload; // http://stackoverflow.com/questions/1226714/how-to-get-browser-to-navigate-to-url-in-javascript

				current_payload = new_payload // directory update!
				console.log("Current Payload: " + current_payload); // for debug
			}

		</script>
		</div>
	</body>

</html>
